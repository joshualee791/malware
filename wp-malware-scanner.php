<?php
/**
 * Plugin Name: WP Malware Scanner
 * Description: A plugin to scan WordPress files for suspicious code patterns and send email reports every 48 hours.
 * Version: 1.0.4
 * Author: Joshua Garza
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

// Hook to add an admin menu item for the scan page
add_action('admin_menu', 'wp_malware_scanner_menu');

// Enqueue Bootstrap and custom JS
add_action('admin_enqueue_scripts', 'wp_malware_scanner_enqueue_scripts');
function wp_malware_scanner_enqueue_scripts() {
    wp_enqueue_style('bootstrap-css', 'https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css');
    wp_enqueue_script('bootstrap-js', 'https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js', array('jquery'), null, true);
    wp_enqueue_script('wp-malware-scanner-js', plugin_dir_url(__FILE__) . 'wp-malware-scanner.js', array('jquery'), null, true);

    // Pass AJAX URL to JavaScript
    wp_localize_script('wp-malware-scanner-js', 'wp_malware_scanner', array(
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce'    => wp_create_nonce('wp_malware_scanner_nonce')
    ));
}

// Function to add the admin menu
function wp_malware_scanner_menu() {
    add_menu_page('WP Malware Scanner', 'Malware Scanner', 'manage_options', 'wp-malware-scanner', 'wp_malware_scanner_page');
    add_submenu_page('wp-malware-scanner', 'Malware Scanner Settings', 'Settings', 'manage_options', 'wp-malware-scanner-settings', 'wp_malware_scanner_settings_page');
}

// Function to render the plugin scan page in the admin and trigger the email after manual scan
function wp_malware_scanner_page() {
    if (isset($_POST['scan'])) {
        // Run the scan when the form is submitted
        $results = wp_malware_scanner_run();

        // Send the email after the scan completes (non-AJAX)
        if (!empty($results['log'])) {
            wp_malware_scanner_send_email($results['log']);
        }

        // Display the scan results in the admin
        echo '<h2>Scan Results</h2>';
        if (!empty($results['log'])) {
            echo '<pre>' . htmlspecialchars($results['log']) . '</pre>';
        } else {
            echo '<p>No suspicious code found.</p>';
        }
    }

    // Render the scan button and UI
    ?>
    <div class="container">
        <h1 class="my-4">WP Malware Scanner</h1>
        <p>Click the button below to run a scan for suspicious code in the <code>wp-content</code> directory.</p>
        <form method="post">
            <button type="submit" name="scan" class="btn btn-primary mb-4">Start Scan</button>
        </form>

        <div class="progress mb-4" style="height: 30px; display:none;">
            <div id="scan-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>

        <div id="scan-results" class="alert alert-info" style="display: none;"></div>
    </div>
    <?php
}

// Function to render the settings page
function wp_malware_scanner_settings_page() {
    if (isset($_POST['email_address'])) {
        update_option('wp_malware_scanner_email', sanitize_email($_POST['email_address']));
        echo '<div class="updated"><p>Email address saved!</p></div>';
    }

    $email = get_option('wp_malware_scanner_email', get_bloginfo('admin_email'));

    echo '<h1>WP Malware Scanner Settings</h1>';
    echo '<form method="post" action="">';
    echo '<table class="form-table">';
    echo '<tr>';
    echo '<th><label for="email_address">Send scan reports to:</label></th>';
    echo '<td><input type="email" name="email_address" id="email_address" value="' . esc_attr($email) . '" class="regular-text" /></td>';
    echo '</tr>';
    echo '</table>';
    submit_button('Save Email Address');
    echo '</form>';
}

// AJAX handler for running the scan and displaying progress (but NOT sending emails)
add_action('wp_ajax_run_wp_malware_scan', 'wp_malware_scanner_ajax_run_scan');
function wp_malware_scanner_ajax_run_scan() {
    check_ajax_referer('wp_malware_scanner_nonce', 'nonce');

    // Run the scan and get results
    $results = wp_malware_scanner_run();

    // Return the scan results to the front-end (UI) without sending the email
    wp_send_json_success([
        'message' => !empty($results['log']) ? $results['log'] : 'No suspicious code found.',
    ]);
}

// Define tighter suspicious patterns
$suspicious_patterns = [
    '/eval\((?!.*json_encode|.*escape|.*unescape).*\)/i', // JavaScript eval() used with suspicious obfuscation
    '/<script.*src=["\']https?:\/\/(?!cdn\.jsdelivr\.net|cdnjs\.cloudflare\.com|ajax\.googleapis\.com).*["\']/i', // External script loading
    '/(?<!wp-admin|wp-includes)base64_decode\(.+\)/i', // PHP base64_decode outside core directories
    '/j = eval\(\'\(.+\'\);/i' // Avoid common eval-based JSON usage
];

// Expanded whitelist of files
$whitelisted_files = [
    ABSPATH . 'wp-admin/js/gallery.js',
    ABSPATH . 'wp-admin/js/gallery.min.js',
    ABSPATH . 'wp-includes/class-wp-recovery-mode-cookie-service.php',
    ABSPATH . 'wp-includes/js/tw-sack.js',
    ABSPATH . 'wp-includes/js/json2.js',
    ABSPATH . 'wp-includes/js/tinymce/plugins/media/plugin.min.js',
    ABSPATH . 'wp-content/themes/twentytwentyone/functions.php', // Trusted theme file
    ABSPATH . 'wp-content/plugins/akismet/akismet.php', // Trusted plugin
];

// Function to recursively scan the wp-content directory for PHP and JS files, excluding minified files and checking modified time
function wp_malware_scanner_run($directory = null) {
    if (!$directory) {
        $directory = ABSPATH . 'wp-content'; // Only scan wp-content directory
    }

    $results = '';
    $thirty_days_ago = time() - 2592000; // Limit to files modified in the last 30 days
    $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($directory));

    foreach ($files as $file) {
        if ($file->isFile() && filemtime($file) > $thirty_days_ago) { // Only scan recently modified files
            $file_path = $file->getRealPath();

            // Skip whitelisted files
            if (in_array($file_path, $whitelisted_files)) {
                continue;
            }

            // Skip minified JS and CSS files
            if (preg_match('/\.min\.(js|css)$/', $file_path)) {
                continue;
            }

            if (preg_match('/\.(php|js)$/', $file_path)) {
                $scan_result = wp_malware_scanner_scan_file($file_path);
                if ($scan_result) {
                    $results .= implode("\n", $scan_result) . "\n";
                }
            }
        }
    }

    return [
        'log' => $results
    ];
}

// Function to scan a single file and capture problematic lines with context
function wp_malware_scanner_scan_file($file_path) {
    global $suspicious_patterns;

    $content = file($file_path); // Read file into an array, each line becomes an element
    $matches = [];

    foreach ($content as $line_number => $line_content) {
        foreach ($suspicious_patterns as $pattern) {
            if (preg_match($pattern, $line_content)) {
                // Capture 2 lines before and 2 lines after for context
                $start_line = max($line_number - 2, 0);
                $end_line = min($line_number + 2, count($content) - 1);

                $context_lines = '';
                for ($i = $start_line; $i <= $end_line; $i++) {
                    $context_lines .= sprintf("%4d: %s", $i + 1, htmlspecialchars($content[$i]));
                }

                $matches[] = "Suspicious code found in file: $file_path on line " . ($line_number + 1) . ":\n" . $context_lines . "\n";
            }
        }
    }

    return $matches;
}

// Function to send the scan results via email with better formatting
function wp_malware_scanner_send_email($scan_results) {
    $to = get_option('wp_malware_scanner_email', get_bloginfo('admin_email'));  // Use the saved email address or the site admin email as fallback
    $subject = 'WordPress Malware Scanner Report';

    // Check if there are any results to report
    if (empty($scan_results)) {
        $message = "No suspicious code was found during the scan.";
    } else {
        $message = "The following files were found to contain suspicious code:\n\n";

        // Group and format the results
        foreach ($scan_results as $result) {
            $message .= $result . "\n";
        }

        // Format the message for readability
        $message = wordwrap($message, 70);
    }

    $headers = ['Content-Type: text/plain; charset=UTF-8'];

    wp_mail($to, $subject, $message, $headers);
}
