jQuery(document).ready(function ($) {
  $("#start-scan").click(function () {
    // Reset progress bar and results section
    $("#scan-progress").css("width", "0%").text("0%");
    $(".progress").show();
    $("#scan-results").hide();

    // Simulate progress as the scan runs
    let progressInterval = setInterval(function () {
      let currentProgress = parseInt($("#scan-progress").attr("aria-valuenow"));
      if (currentProgress < 90) {
        currentProgress += 10;
        $("#scan-progress")
          .css("width", currentProgress + "%")
          .attr("aria-valuenow", currentProgress)
          .text(currentProgress + "%");
      }
    }, 500); // Increment the progress every 500ms for visual feedback

    $.ajax({
      url: wp_malware_scanner.ajax_url,
      type: "POST",
      data: {
        action: "run_wp_malware_scan",
        nonce: wp_malware_scanner.nonce,
      },
      success: function (response) {
        clearInterval(progressInterval); // Stop progress interval when the scan completes
        $("#scan-progress")
          .css("width", "100%")
          .attr("aria-valuenow", 100)
          .text("100%");

        let scanResults = response.data.message;

        // Format the scan results with line breaks and HTML for readability
        scanResults = scanResults.replace(/\n/g, "<br>");

        $("#scan-results")
          .html(
            "<strong>Scan Complete:</strong><br><pre>" + scanResults + "</pre>"
          )
          .show();
      },
      error: function () {
        clearInterval(progressInterval); // Stop progress interval if there's an error
        $("#scan-results")
          .html("<strong>Error:</strong> Something went wrong during the scan.")
          .show();
      },
    });
  });
});
