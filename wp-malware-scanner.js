jQuery(document).ready(function ($) {
  $("#start-scan").click(function () {
    $("#scan-progress").css("width", "0%").text("0%");
    $(".progress").show();
    $("#scan-results").hide();

    $.ajax({
      url: wp_malware_scanner.ajax_url,
      type: "POST",
      data: {
        action: "run_wp_malware_scan",
        nonce: wp_malware_scanner.nonce,
      },
      xhr: function () {
        var xhr = new window.XMLHttpRequest();
        xhr.upload.addEventListener(
          "progress",
          function (evt) {
            if (evt.lengthComputable) {
              var percentComplete = (evt.loaded / evt.total) * 100;
              $("#scan-progress")
                .css("width", percentComplete + "%")
                .text(Math.round(percentComplete) + "%");
            }
          },
          false
        );
        return xhr;
      },
      success: function (response) {
        $("#scan-progress").css("width", "100%").text("100%");
        $("#scan-results")
          .html("<strong>Scan Complete:</strong><br>" + response.data.message)
          .show();
      },
      error: function () {
        $("#scan-results")
          .html("<strong>Error:</strong> Something went wrong during the scan.")
          .show();
      },
    });
  });
});
